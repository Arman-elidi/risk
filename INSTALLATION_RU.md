# AI Risk Orchestrator - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –£—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–°–∏—Å—Ç–µ–º–Ω—ã–µ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Å–∏—Å—Ç–µ–º–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
2. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–¥–ª—è-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
4. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Dify AI](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-dify-ai)
5. [–ó–∞–ø—É—Å–∫ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#–∑–∞–ø—É—Å–∫-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
6. [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è](#—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
7. [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API](#–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-api)
8. [–†–µ—à–µ–Ω–∏–µ –ü—Ä–æ–±–ª–µ–º](#—Ä–µ—à–µ–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º)

---

## 1. –°–∏—Å—Ç–µ–º–Ω—ã–µ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- **CPU**: 4 —è–¥—Ä–∞
- **RAM**: 8 GB
- **Storage**: 50 GB SSD

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ
- **Python**: 3.11+
- **PostgreSQL**: 15+
- **Redis**: 7+ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **Node.js**: 18+ (–¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)
- **Docker**: 24+ (–¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏)

---

## 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
cd ~/Documents
# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ RISK/
cd RISK
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –û–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python3.11 -m venv venv

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
source venv/bin/activate  # macOS/Linux
# –∏–ª–∏
venv\Scripts\activate  # Windows
```

### –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –û–±–Ω–æ–≤–∏—Ç—å pip
pip install --upgrade pip

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É risk-core
pip install -e risk-core/
```

### –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd risk-frontend
npm install
cd ..
```

---

## 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ò—Å–ø–æ–ª—å–∑—É—è Docker (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL
docker run -d \
  --name risk-postgres \
  -p 5432:5432 \
  -e POSTGRES_DB=risk_orchestrator \
  -e POSTGRES_USER=riskuser \
  -e POSTGRES_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å \
  -v risk_postgres_data:/var/lib/postgresql/data \
  postgres:15

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
docker run -d \
  --name risk-redis \
  -p 6379:6379 \
  redis:7-alpine
```

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –†—É—á–Ω–∞—è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL

**macOS (Homebrew):**
```bash
brew install postgresql@15
brew services start postgresql@15

# –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
createdb risk_orchestrator
createuser riskuser -P  # –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install postgresql-15
sudo systemctl start postgresql

# –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–∑—É
sudo -u postgres psql
postgres=# CREATE USER riskuser WITH PASSWORD '–≤–∞—à_–ø–∞—Ä–æ–ª—å';
postgres=# CREATE DATABASE risk_orchestrator OWNER riskuser;
postgres=# \q
```

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –û–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp .env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env
nano .env
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`:**

```bash
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
SECRET_KEY=–≤–∞—à-256-–±–∏—Ç–Ω—ã–π-—Å–µ–∫—Ä–µ—Ç–Ω—ã–π-–∫–ª—é—á
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
DATABASE_URL=postgresql+asyncpg://riskuser:–≤–∞—à_–ø–∞—Ä–æ–ª—å@localhost:5432/risk_orchestrator

# Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
REDIS_URL=redis://localhost:6379/0

# Dify AI (—Å–º. —Ä–∞–∑–¥–µ–ª 4)
DIFY_API_URL=http://localhost:3001/v1
DIFY_API_KEY=–≤–∞—à-dify-api-–∫–ª—é—á

# Email/SMS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=–≤–∞—à-email@gmail.com
SMTP_PASSWORD=–ø–∞—Ä–æ–ª—å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

# –û–∫—Ä—É–∂–µ–Ω–∏–µ
ENVIRONMENT=development
DEBUG=true
LOG_LEVEL=INFO
```

### –®–∞–≥ 6: –ó–∞–ø—É—Å–∫ –ú–∏–≥—Ä–∞—Ü–∏–π –ë–î

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

---

## 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Dify AI

### –ß—Ç–æ —Ç–∞–∫–æ–µ Dify?

**Dify** ‚Äî —ç—Ç–æ low-code –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è AI-–∞–≥–µ–Ω—Ç–æ–≤. –í —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ Dify –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞**:

- ‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ä–µ–∑—é–º–µ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
- ‚úÖ –û–±—ä—è—Å–Ω–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤
- ‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –ø–∏—Å–µ–º –¥–ª—è —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤

**–í–∞–∂–Ω–æ**: Dify **–ù–ï** –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Ä–∞—Å—á—ë—Ç–∞–º–∏ —Ä–∏—Å–∫–æ–≤, –ª–∏–º–∏—Ç–∞–º–∏ –∏–ª–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö.

---

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Dify (Self-Hosted)

**–ò—Å–ø–æ–ª—å–∑—É—è Docker Compose:**

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è Dify
mkdir -p ~/dify
cd ~/dify

# –°–∫–∞—á–∞—Ç—å Dify
git clone https://github.com/langgenius/dify.git
cd dify/docker

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Dify
docker-compose up -d
```

**–ü–æ–¥–æ–∂–¥–∞—Ç—å 2-3 –º–∏–Ω—É—Ç—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, –∑–∞—Ç–µ–º –æ—Ç–∫—Ä—ã—Ç—å:**
- **Dify UI**: http://localhost:3001
- **API**: http://localhost:3001/v1

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ê–∫–∫–∞—É–Ω—Ç–∞ –≤ Dify

1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:3001
2. –ù–∞–∂–∞—Ç—å "Sign Up" (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
3. –í–≤–µ—Å—Ç–∏ email/–ø–∞—Ä–æ–ª—å
4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email (–≤ dev-—Ä–µ–∂–∏–º–µ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)

---

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI –ú–æ–¥–µ–ª–µ–π –≤ Dify

1. **–ü–µ—Ä–µ–π—Ç–∏ –≤ Settings** (–≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª)
2. **–ù–∞–∂–∞—Ç—å "Model Provider"**
3. **–î–æ–±–∞–≤–∏—Ç—å OpenAI API Key** (–∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞):
   - Provider: OpenAI
   - API Key: `sk-...` (–≤–∞—à OpenAI –∫–ª—é—á)
   - Model: `gpt-4` –∏–ª–∏ `gpt-3.5-turbo`
4. **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å**

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
- Azure OpenAI
- Anthropic Claude
- Cohere
- –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Ollama, LM Studio)

---

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ AI Workflows –≤ Dify

#### Workflow 1: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –†–µ–∑—é–º–µ –¥–ª—è –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞

1. **–ù–∞–∂–∞—Ç—å "Create Workflow"** ‚Üí "Text Generation"
2. **–ù–∞–∑–≤–∞–Ω–∏–µ**: `Risk Executive Summary`
3. **–î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:
   - `snapshot_date` (—Ç–µ–∫—Å—Ç)
   - `var_1d_95` (—á–∏—Å–ª–æ)
   - `stressed_var` (—á–∏—Å–ª–æ)
   - `dv01_total` (—á–∏—Å–ª–æ)
   - `capital_ratio` (—á–∏—Å–ª–æ)
   - `lcr_ratio` (—á–∏—Å–ª–æ)
   - `critical_alerts` (—Ç–µ–∫—Å—Ç)
4. **–î–æ–±–∞–≤–∏—Ç—å LLM Node**:
   - Model: GPT-4
   - System Prompt:
     ```
     –í—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏, —Ä–µ–≥—É–ª–∏—Ä—É–µ–º–æ–π CySEC.
     –°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (–º–∞–∫—Å–∏–º—É–º 300 —Å–ª–æ–≤) –¥–ª—è —Å–æ–≤–µ—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤.
     
     –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞:
     - –ò–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —Ä–∏—Å–∫–∞
     - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞–ª–µ—Ä—Ç–∞—Ö –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–∏ –Ω–∞ –±–∏–∑–Ω–µ—Å
     - –°—Ç–∞—Ç—É—Å–µ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
     - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö
     
     –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫.
     ```
   - User Prompt:
     ```
     –î–∞—Ç–∞: {{snapshot_date}}
     
     –†—ã–Ω–æ—á–Ω—ã–π —Ä–∏—Å–∫:
     - VaR (1d 95%): {{var_1d_95}} EUR
     - Stressed VaR: {{stressed_var}} EUR
     - DV01: {{dv01_total}} EUR
     
     –ö–∞–ø–∏—Ç–∞–ª –∏ –õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å:
     - Capital Ratio: {{capital_ratio}}%
     - LCR: {{lcr_ratio}}%
     
     –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ê–ª–µ—Ä—Ç—ã:
     {{critical_alerts}}
     
     –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑—é–º–µ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞.
     ```
5. **–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å Workflow**
6. **–ü–æ–ª—É—á–∏—Ç—å API Key**: Settings ‚Üí API Keys ‚Üí Create ‚Üí Copy

---

#### Workflow 2: –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ê–ª–µ—Ä—Ç–æ–≤

1. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Workflow**: `Alert Explanation`
2. **–í—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**:
   - `alert_type` (—Ç–µ–∫—Å—Ç)
   - `metric_name` (—Ç–µ–∫—Å—Ç)
   - `current_value` (—á–∏—Å–ª–æ)
   - `limit_value` (—á–∏—Å–ª–æ)
   - `severity` (—Ç–µ–∫—Å—Ç)
3. **LLM Node**:
   - System Prompt:
     ```
     –í—ã ‚Äî —Ä–∏—Å–∫-–∞–Ω–∞–ª–∏—Ç–∏–∫. –û–±—ä—è—Å–Ω–∏—Ç–µ –∞–ª–µ—Ä—Ç—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º –¥–ª—è —Ä–∏—Å–∫-–æ—Ñ–∏—Ü–µ—Ä–æ–≤.
     –í–∫–ª—é—á–∏—Ç–µ:
     1. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ
     2. –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
     3. –ö–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å
     ```
   - User Prompt:
     ```
     –¢–∏–ø –∞–ª–µ—Ä—Ç–∞: {{alert_type}}
     –ú–µ—Ç—Ä–∏–∫–∞: {{metric_name}}
     –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {{current_value}}
     –õ–∏–º–∏—Ç: {{limit_value}}
     –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å: {{severity}}
     
     –û–±—ä—è—Å–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∞–ª–µ—Ä—Ç –∏ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è.
     ```
4. **–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å** ‚Üí **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å API Key**

---

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Dify –≤ Risk Orchestrator

**–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `.env`:**

```bash
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Dify
DIFY_API_URL=http://localhost:3001/v1
DIFY_API_KEY_SUMMARY=app-xxx...  # –ò–∑ Workflow 1
DIFY_API_KEY_ALERT=app-yyy...    # –ò–∑ Workflow 2
```

**–°–µ—Ä–≤–∏—Å Dify —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –∫–æ–¥–µ:**

–§–∞–π–ª: `app/services/dify_service.py` (—Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ):

```python
"""
Dify AI Integration Service
Generates text using Dify workflows
"""
import httpx
import structlog
from app.core.config import settings

logger = structlog.get_logger()


async def generate_executive_summary(snapshot_data: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∑—é–º–µ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ Dify
    
    Args:
        snapshot_data: –î–∞–Ω–Ω—ã–µ —Ä–∏—Å–∫-snapshot
    
    Returns:
        –¢–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ (–¥–æ 300 —Å–ª–æ–≤)
    """
    try:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post(
                f"{settings.DIFY_API_URL}/workflows/run",
                headers={
                    "Authorization": f"Bearer {settings.DIFY_API_KEY_SUMMARY}",
                    "Content-Type": "application/json",
                },
                json={
                    "inputs": {
                        "snapshot_date": str(snapshot_data["snapshot_date"]),
                        "var_1d_95": float(snapshot_data["var_1d_95"]),
                        "stressed_var": float(snapshot_data["stressed_var"]),
                        "dv01_total": float(snapshot_data["dv01_total"]),
                        "capital_ratio": float(snapshot_data["capital_ratio"]),
                        "lcr_ratio": float(snapshot_data["lcr_ratio"]),
                        "critical_alerts": snapshot_data["critical_alerts"],
                    },
                    "response_mode": "blocking",
                    "user": "risk-system",
                },
            )
            
            response.raise_for_status()
            result = response.json()
            
            summary = result["data"]["outputs"]["text"]
            logger.info("executive_summary_generated", length=len(summary))
            return summary
            
    except Exception as e:
        logger.error("dify_summary_failed", error=str(e))
        return f"[–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∑—é–º–µ: {str(e)}]"


async def generate_alert_explanation(alert_data: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞ —á–µ—Ä–µ–∑ Dify
    
    Args:
        alert_data: –î–∞–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç–∞
    
    Returns:
        –¢–µ–∫—Å—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
    """
    try:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post(
                f"{settings.DIFY_API_URL}/workflows/run",
                headers={
                    "Authorization": f"Bearer {settings.DIFY_API_KEY_ALERT}",
                    "Content-Type": "application/json",
                },
                json={
                    "inputs": alert_data,
                    "response_mode": "blocking",
                    "user": "risk-system",
                },
            )
            
            response.raise_for_status()
            result = response.json()
            
            explanation = result["data"]["outputs"]["text"]
            logger.info("alert_explanation_generated")
            return explanation
            
    except Exception as e:
        logger.error("dify_alert_failed", error=str(e))
        return f"[–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è: {str(e)}]"
```

---

## 5. –ó–∞–ø—É—Å–∫ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ó–∞–ø—É—Å–∫ Backend (API)

```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source venv/bin/activate

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É**: http://localhost:8000

**Swagger –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: http://localhost:8000/docs

---

### –ó–∞–ø—É—Å–∫ Frontend (React)

```bash
# –í –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
cd risk-frontend

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev server
npm run dev
```

**Frontend –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É**: http://localhost:3000

---

### –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ —á–µ—Ä–µ–∑ Docker Compose

```bash
# –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f risk-api

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose down
```

**–°–µ—Ä–≤–∏—Å—ã:**
- API: http://localhost:8000
- Frontend: http://localhost:3000
- PostgreSQL: localhost:5432
- Redis: localhost:6379
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3001

---

## 6. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 6.1 –ü–µ—Ä–≤—ã–π –í—Ö–æ–¥ –≤ –°–∏—Å—Ç–µ–º—É

**–°–æ–∑–¥–∞–Ω–∏–µ Admin –ê–∫–∫–∞—É–Ω—Ç–∞** (–≤—Ä—É—á–Ω—É—é –≤ –ë–î):

```sql
-- –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
psql -U riskuser -d risk_orchestrator

-- –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
INSERT INTO users (username, email, hashed_password, role, is_active, created_at)
VALUES (
  'admin',
  'admin@yourcompany.com',
  '$2b$12$...', -- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ bcrypt –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
  'ADMIN',
  true,
  NOW()
);
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Hash –ü–∞—Ä–æ–ª—è:**

```python
# –í Python –∫–æ–Ω—Å–æ–ª–∏
from passlib.context import CryptContext
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
print(pwd_context.hash("–≤–∞—à_–ø–∞—Ä–æ–ª—å"))
```

**–í—Ö–æ–¥:**
1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:3000
2. Username: `admin`
3. Password: `–≤–∞—à_–ø–∞—Ä–æ–ª—å`

---

### 6.2 –°–æ–∑–¥–∞–Ω–∏–µ –ü–æ—Ä—Ç—Ñ–µ–ª–µ–π

**–ß–µ—Ä–µ–∑ API:**

```bash
curl -X POST http://localhost:8000/api/v1/portfolios \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "portfolio_name": "Cyprus Main Fund",
    "entity_id": 1,
    "base_currency": "EUR",
    "is_active": true
  }'
```

**–ß–µ—Ä–µ–∑ Web UI:**
1. Dashboard ‚Üí "Portfolios"
2. –ù–∞–∂–∞—Ç—å "Create Portfolio"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

---

### 6.3 –ó–∞–≥—Ä—É–∑–∫–∞ –ü–æ–∑–∏—Ü–∏–π

**–§–æ—Ä–º–∞—Ç CSV** (`positions.csv`):

```csv
portfolio_name,instrument_type,isin,notional,clean_price,coupon_rate,maturity_date
Cyprus Main Fund,BOND,US912828Z230,1000000,98.5,0.025,2030-12-31
Cyprus Main Fund,BOND,DE0001102408,500000,102.0,0.035,2028-06-30
```

**–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ API:**

```bash
curl -X POST http://localhost:8000/api/v1/batch/upload-positions \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN" \
  -F "file=@positions.csv"
```

---

### 6.4 –ó–∞–ø—É—Å–∫ –†–∞—Å—á—ë—Ç–æ–≤ –†–∏—Å–∫–æ–≤

**On-Demand –†–∞—Å—á—ë—Ç:**

```bash
curl -X POST http://localhost:8000/api/v1/risk/calculate \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "portfolio_id": 1,
    "as_of_date": "2024-12-01",
    "calculation_type": "FULL"
  }'
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ù–æ—á–Ω–æ–π Batch:**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ **00:00 UTC**
- –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ `app/scheduler/jobs.py`

---

### 6.5 –ü—Ä–æ—Å–º–æ—Ç—Ä Risk Dashboard

1. **–û—Ç–∫—Ä—ã—Ç—å Dashboard**: http://localhost:3000
2. **–í—ã–±—Ä–∞—Ç—å –ü–æ—Ä—Ç—Ñ–µ–ª—å**: Dropdown —Å–≤–µ—Ä—Ö—É
3. **–ü—Ä–æ—Å–º–æ—Ç—Ä –ú–µ—Ç—Ä–∏–∫**:
   - VaR (1d 95%)
   - DV01
   - Capital Ratio
   - LCR
   - –ê–∫—Ç–∏–≤–Ω—ã–µ –ê–ª–µ—Ä—Ç—ã
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ì—Ä–∞—Ñ–∏–∫–æ–≤**:
   - VaR Time Series (30 –¥–Ω–µ–π)
   - Capital Adequacy Breakdown
5. **–ü—Ä–æ—Å–º–æ—Ç—Ä –¢–∞–±–ª–∏—Ü—ã –ê–ª–µ—Ä—Ç–æ–≤**:
   - –§–∏–ª—å—Ç—Ä –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤

---

### 6.6 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –û—Ç—á—ë—Ç–æ–≤

**–†—É—á–Ω–∞—è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è:**

```bash
curl -X POST http://localhost:8000/api/v1/reports/pdf/generate \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN" \
  -d '{"report_date": "2024-12-01"}'
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –û—Ç—á—ë—Ç—ã:**
- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤ **01:00 UTC** –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
- –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `/var/risk-reports/`
- –í–∫–ª—é—á–∞—é—Ç:
  - Executive Summary (–æ—Ç Dify)
  - –ì—Ä–∞—Ñ–∏–∫–∏ VaR
  - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ê–ª–µ—Ä—Ç—ã
  - –¢–æ–ø-5 –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

---

### 6.7 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –õ–∏–º–∏—Ç–æ–≤ –†–∏—Å–∫–æ–≤

**–°–æ–∑–¥–∞–Ω–∏–µ –õ–∏–º–∏—Ç–∞:**

```bash
curl -X POST http://localhost:8000/api/v1/limits \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "portfolio_id": 1,
    "limit_type": "VAR_1D_95",
    "limit_value": 100000,
    "warning_threshold": 0.8,
    "critical_threshold": 0.95,
    "is_active": true
  }'
```

**–¢–∏–ø—ã –õ–∏–º–∏—Ç–æ–≤:**
- `VAR_1D_95` - Value at Risk (1-–¥–Ω–µ–≤–Ω—ã–π, 95%)
- `STRESSED_VAR` - Stressed VaR
- `DV01` - –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- `CAPITAL_RATIO` - –†–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
- `LCR` - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å—é

---

### 6.8 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê–ª–µ—Ä—Ç–∞–º–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä –ê–∫—Ç–∏–≤–Ω—ã—Ö –ê–ª–µ—Ä—Ç–æ–≤:**

```bash
curl http://localhost:8000/api/v1/alerts?acknowledged=false \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN"
```

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ê–ª–µ—Ä—Ç–∞:**

```bash
curl -X POST http://localhost:8000/api/v1/alerts/123/acknowledge \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN"
```

**–£—Ä–æ–≤–Ω–∏ –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏:**
- üü¢ **GREEN**: –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ
- üü° **YELLOW**: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (80% –ª–∏–º–∏—Ç–∞)
- üî¥ **RED**: –ö—Ä–∏—Ç–∏—á–Ω–æ (95% –ª–∏–º–∏—Ç–∞)
- üî¥ **CRITICAL**: –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ (>100% –ª–∏–º–∏—Ç–∞)

---

## 7. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

**–ü–æ–ª—É—á–µ–Ω–∏–µ JWT Token:**

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "–≤–∞—à_–ø–∞—Ä–æ–ª—å"
  }'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 3600
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Token –≤ –ó–∞–ø—Ä–æ—Å–∞—Ö:**

```bash
curl http://localhost:8000/api/v1/portfolios \
  -H "Authorization: Bearer –í–ê–®_JWT_TOKEN"
```

---

### –û—Å–Ω–æ–≤–Ω—ã–µ Endpoints

**Health Check:**
```
GET /api/v1/health
```

**–ü–æ—Ä—Ç—Ñ–µ–ª–∏:**
```
GET    /api/v1/portfolios           # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö
POST   /api/v1/portfolios           # –°–æ–∑–¥–∞—Ç—å
GET    /api/v1/portfolios/{id}      # –ü–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω
PUT    /api/v1/portfolios/{id}      # –û–±–Ω–æ–≤–∏—Ç—å
DELETE /api/v1/portfolios/{id}      # –£–¥–∞–ª–∏—Ç—å
```

**–†–∞—Å—á—ë—Ç—ã –†–∏—Å–∫–æ–≤:**
```
POST   /api/v1/risk/calculate       # On-demand —Ä–∞—Å—á—ë—Ç
GET    /api/v1/risk_snapshots       # –°–ø–∏—Å–æ–∫ snapshots
GET    /api/v1/risk_snapshots/{id}  # –î–µ—Ç–∞–ª–∏ snapshot
```

**–ê–ª–µ—Ä—Ç—ã:**
```
GET    /api/v1/alerts               # –°–ø–∏—Å–æ–∫ –∞–ª–µ—Ä—Ç–æ–≤
POST   /api/v1/alerts/{id}/acknowledge
```

**–û—Ç—á—ë—Ç—ã:**
```
POST   /api/v1/reports/pdf/generate
GET    /api/v1/reports/pdf/download?report_date=2024-12-01
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```
GET    /api/v1/metrics              # Prometheus –º–µ—Ç—Ä–∏–∫–∏
GET    /api/v1/audit                # –ê—É–¥–∏—Ç (—Ç–æ–ª—å–∫–æ admin)
```

**–ü–æ–ª–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API:**
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

---

## 8. –†–µ—à–µ–Ω–∏–µ –ü—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

**–û—à–∏–±–∫–∞:**
```
sqlalchemy.exc.OperationalError: could not connect to server
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω:
   ```bash
   docker ps | grep postgres
   # –∏–ª–∏
   pg_isready -h localhost -p 5432
   ```
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `DATABASE_URL` –≤ `.env`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ firewall

---

### –ü—Ä–æ–±–ª–µ–º–∞: Dify API –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized

**–û—à–∏–±–∫–∞:**
```
{"detail": "Invalid API key"}
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ API key –≤ `.env` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Dify workflow
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Dify –∑–∞–ø—É—â–µ–Ω: http://localhost:3001
3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å API key –≤ Dify –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

### –ü—Ä–æ–±–ª–µ–º–∞: Frontend –ù–µ –ú–æ–∂–µ—Ç –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Backend

**–û—à–∏–±–∫–∞:**
```
Network Error: Failed to fetch
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8000
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`:
   ```bash
   CORS_ORIGINS=http://localhost:3000
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å proxy –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `vite.config.ts`

---

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–µ—Å—Ç—ã –ü–∞–¥–∞—é—Ç

**–û—à–∏–±–∫–∞:**
```
ERROR: could not connect to database
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É:
   ```bash
   createdb risk_orchestrator_test
   ```
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º env:
   ```bash
   export DATABASE_URL=postgresql+asyncpg://riskuser:password@localhost:5432/risk_orchestrator_test
   pytest
   ```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Docker Compose –ù–µ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–û—à–∏–±–∫–∞:**
```
Error: port 5432 already in use
```

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π PostgreSQL:
   ```bash
   brew services stop postgresql@15
   # –∏–ª–∏
   sudo systemctl stop postgresql
   ```
2. –ò–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç –≤ `docker-compose.yml`:
   ```yaml
   ports:
     - "5433:5432"  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 5433 –Ω–∞ —Ö–æ—Å—Ç–µ
   ```

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **GitHub Issues**: –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –∑–∞–ø—Ä–æ—Å—ã —Ñ—É–Ω–∫—Ü–∏–π
- **API Docs**: http://localhost:8000/docs
- **Prometheus Metrics**: http://localhost:9090
- **Grafana Dashboards**: http://localhost:3001

---

## Best Practices –ø–æ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–ò–∑–º–µ–Ω–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–æ–ª–∏** –≤ production
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–ª—å–Ω—ã–π SECRET_KEY** (256-bit —Å–ª—É—á–∞–π–Ω—ã–π)
3. **–í–∫–ª—é—á–∏—Ç—å HTTPS** —Å Let's Encrypt
4. **–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ë–î** —Ç–æ–ª—å–∫–æ localhost –∏–ª–∏ VPN
5. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vault** –¥–ª—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ production
6. **–í–∫–ª—é—á–∏—Ç—å rate limiting** –Ω–∞ API endpoints
7. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å audit logs**
8. **–û–±–Ω–æ–≤–ª—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** (`pip install --upgrade`)

---

## –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Dify
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏
5. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ä–∞—Å—á—ë—Ç —Ä–∏—Å–∫–æ–≤
6. ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –æ—Ç—á—ë—Ç
7. ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª–µ—Ä—Ç—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏–º–∏—Ç—ã
8. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å email/SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production!** üöÄ

---

## –ü—Ä–∏–º–µ—Ä—ã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Dify –≤ –°–∏—Å—Ç–µ–º–µ

### –ü—Ä–∏–º–µ—Ä 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –†–µ–∑—é–º–µ –≤ PDF –û—Ç—á—ë—Ç–µ

```python
# –í app/services/pdf_report.py
from app.services.dify_service import generate_executive_summary

async def generate_daily_pdf(session, report_date):
    # ... –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ...
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Dify
    snapshot_data = {
        "snapshot_date": str(report_date),
        "var_1d_95": snapshot.var_1d_95,
        "stressed_var": snapshot.stressed_var,
        "dv01_total": snapshot.dv01_total,
        "capital_ratio": snapshot.capital_ratio,
        "lcr_ratio": snapshot.lcr_ratio,
        "critical_alerts": format_critical_alerts(alerts),
    }
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—é–º–µ —á–µ—Ä–µ–∑ Dify
    executive_summary = await generate_executive_summary(snapshot_data)
    
    # –í—Å—Ç–∞–≤–∫–∞ –≤ PDF
    html_content = f"""
    <div class="executive-summary">
        <h2>Executive Summary</h2>
        <p>{executive_summary}</p>
    </div>
    """
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ PDF ...
```

### –ü—Ä–∏–º–µ—Ä 2: –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ê–ª–µ—Ä—Ç–∞ –ø—Ä–∏ –°–æ–∑–¥–∞–Ω–∏–∏

```python
# –í app/services/alert_engine.py
from app.services.dify_service import generate_alert_explanation

async def create_alert_with_explanation(session, alert_data):
    # –°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç
    alert = Alert(**alert_data)
    session.add(alert)
    
    # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Dify
    explanation = await generate_alert_explanation({
        "alert_type": alert.alert_type,
        "metric_name": alert.metric_name,
        "current_value": alert.current_value,
        "limit_value": alert.limit_value,
        "severity": alert.severity,
    })
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    alert.ai_explanation = explanation
    await session.commit()
    
    return alert
```

### –ü—Ä–∏–º–µ—Ä 3: API Endpoint –¥–ª—è –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –†–µ–∑—é–º–µ

```python
# –í app/api/reports.py
from app.services.dify_service import generate_executive_summary

@router.post("/reports/summary")
async def get_executive_summary(
    snapshot_id: int,
    db: AsyncSession = Depends(get_db),
    user=Depends(auth_bearer),
):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Executive Summary –¥–ª—è snapshot"""
    snapshot = await db.get(RiskSnapshot, snapshot_id)
    if not snapshot:
        raise HTTPException(404, "Snapshot not found")
    
    snapshot_data = {
        "snapshot_date": str(snapshot.snapshot_date),
        "var_1d_95": snapshot.var_1d_95,
        "stressed_var": snapshot.stressed_var,
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
    }
    
    summary = await generate_executive_summary(snapshot_data)
    
    return {"summary": summary, "snapshot_id": snapshot_id}
```

---

**–ì–æ—Ç–æ–≤–æ! –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.** üìö
